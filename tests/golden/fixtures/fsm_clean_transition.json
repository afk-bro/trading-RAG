{
  "name": "clean_transition",
  "description": "Clear transition from one regime to another after M bars with confidence >= C_enter. Tests: transition event firing, age reset to 1, candidate cleared after transition.",
  "config": {
    "M": 5,
    "C_enter": 0.75,
    "C_exit": 0.55
  },
  "steps": [
    {
      "comment": "Step 0: Initialize with first regime",
      "raw_key": "trend=uptrend|vol=high_vol",
      "confidence": 0.85,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 1
      },
      "transition": false
    },
    {
      "comment": "Step 1: Build up regime age",
      "raw_key": "trend=uptrend|vol=high_vol",
      "confidence": 0.82,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 2
      },
      "transition": false
    },
    {
      "comment": "Step 2: Continue building age",
      "raw_key": "trend=uptrend|vol=high_vol",
      "confidence": 0.88,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 3
      },
      "transition": false
    },
    {
      "comment": "Step 3: More age",
      "raw_key": "trend=uptrend|vol=high_vol",
      "confidence": 0.80,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 4: Final stable bar before candidate starts (age=5)",
      "raw_key": "trend=uptrend|vol=high_vol",
      "confidence": 0.84,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 5
      },
      "transition": false
    },
    {
      "comment": "Step 5: New regime appears, candidate count=1, high confidence",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.80,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": "trend=downtrend|vol=low_vol",
        "candidate_count": 1,
        "regime_age_bars": 5
      },
      "transition": false
    },
    {
      "comment": "Step 6: Candidate persists, count=2",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.78,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": "trend=downtrend|vol=low_vol",
        "candidate_count": 2,
        "regime_age_bars": 5
      },
      "transition": false
    },
    {
      "comment": "Step 7: Candidate persists, count=3",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.76,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": "trend=downtrend|vol=low_vol",
        "candidate_count": 3,
        "regime_age_bars": 5
      },
      "transition": false
    },
    {
      "comment": "Step 8: Candidate persists, count=4",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.82,
      "expected_state": {
        "stable_key": "trend=uptrend|vol=high_vol",
        "candidate_key": "trend=downtrend|vol=low_vol",
        "candidate_count": 4,
        "regime_age_bars": 5
      },
      "transition": false
    },
    {
      "comment": "Step 9: 5th bar (M=5) - TRANSITION! Median of [0.80, 0.78, 0.76, 0.82, 0.79]=0.79 >= 0.75",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.79,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 1
      },
      "transition": true,
      "transition_event": {
        "from_key": "trend=uptrend|vol=high_vol",
        "to_key": "trend=downtrend|vol=low_vol",
        "median_confidence": 0.79
      }
    },
    {
      "comment": "Step 10: New stable regime, age increments",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.85,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 2
      },
      "transition": false
    },
    {
      "comment": "Step 11: Continue in new stable regime",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.83,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 3
      },
      "transition": false
    },
    {
      "comment": "Step 12: Continue in new stable regime",
      "raw_key": "trend=downtrend|vol=low_vol",
      "confidence": 0.81,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 13: Third regime starts building candidate from new stable",
      "raw_key": "trend=flat|vol=medium_vol",
      "confidence": 0.77,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": "trend=flat|vol=medium_vol",
        "candidate_count": 1,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 14: Candidate persists",
      "raw_key": "trend=flat|vol=medium_vol",
      "confidence": 0.78,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": "trend=flat|vol=medium_vol",
        "candidate_count": 2,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 15: Candidate persists",
      "raw_key": "trend=flat|vol=medium_vol",
      "confidence": 0.80,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": "trend=flat|vol=medium_vol",
        "candidate_count": 3,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 16: Candidate persists",
      "raw_key": "trend=flat|vol=medium_vol",
      "confidence": 0.76,
      "expected_state": {
        "stable_key": "trend=downtrend|vol=low_vol",
        "candidate_key": "trend=flat|vol=medium_vol",
        "candidate_count": 4,
        "regime_age_bars": 4
      },
      "transition": false
    },
    {
      "comment": "Step 17: Second transition! Median of [0.77, 0.78, 0.80, 0.76, 0.79]=0.78 >= 0.75",
      "raw_key": "trend=flat|vol=medium_vol",
      "confidence": 0.79,
      "expected_state": {
        "stable_key": "trend=flat|vol=medium_vol",
        "candidate_key": null,
        "candidate_count": 0,
        "regime_age_bars": 1
      },
      "transition": true,
      "transition_event": {
        "from_key": "trend=downtrend|vol=low_vol",
        "to_key": "trend=flat|vol=medium_vol",
        "median_confidence": 0.78
      }
    }
  ]
}
