{# Partial template for HTMX - just the table and pagination #}

{% if error %}
<div class="empty-state">
    <h3>Error</h3>
    <p>{{ error }}</p>
</div>
{% elif entries %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th class="select-col" title="Select for comparison">
                    Compare
                </th>
                <th class="rank-col">#</th>
                <th class="sparkline-col">Equity</th>
                <th>Strategy</th>
                <th>Objective Score</th>
                <th>Return %</th>
                <th>Sharpe</th>
                <th>Max DD %</th>
                <th>Trades</th>
                <th>Overfit Gap</th>
                <th>Objective</th>
                <th>OOS</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr class="clickable-row" data-href="/admin/backtests/tunes/{{ entry.tune_id }}" data-tune-id="{{ entry.tune_id }}">
                <td class="select-col" onclick="event.stopPropagation()">
                    {% if entry.best_run_id %}
                    <input type="checkbox" class="js-compare-toggle" data-id="{{ entry.best_run_id }}" title="Add to compare">
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td class="rank-col">
                    <span class="rank-badge {% if loop.index <= 3 %}rank-top{% endif %}">{{ loop.index + offset }}</span>
                </td>
                <td class="sparkline-col">
                    {% if entry.best_run_id %}
                    <div class="sparkline" data-run-id="{{ entry.best_run_id }}"></div>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.strategy_name %}
                        <a href="/admin/kb/entities/{{ entry.strategy_entity_id }}" onclick="event.stopPropagation()">{{ entry.strategy_name }}</a>
                    {% else %}
                        <span class="text-muted">{{ entry.strategy_entity_id[:8] }}...</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.best_objective_score is not none %}
                        <strong class="score-value">{{ "%.4f"|format(entry.best_objective_score) }}</strong>
                    {% elif entry.score_oos is not none %}
                        <strong class="score-value">{{ "%.4f"|format(entry.score_oos) }}</strong>
                    {% elif entry.best_score is not none %}
                        <strong class="score-value">{{ "%.4f"|format(entry.best_score) }}</strong>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.best_metrics_oos and entry.best_metrics_oos.return_pct is not none %}
                        <span class="{{ 'positive' if entry.best_metrics_oos.return_pct > 0 else 'negative' }}">
                            {{ "%.2f"|format(entry.best_metrics_oos.return_pct) }}%
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.best_metrics_oos and entry.best_metrics_oos.sharpe is not none %}
                        <span class="{{ 'positive' if entry.best_metrics_oos.sharpe > 0 else 'negative' }}">
                            {{ "%.2f"|format(entry.best_metrics_oos.sharpe) }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.best_metrics_oos and entry.best_metrics_oos.max_drawdown_pct is not none %}
                        <span class="negative">{{ "%.1f"|format(entry.best_metrics_oos.max_drawdown_pct) }}%</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.best_metrics_oos and entry.best_metrics_oos.trades is not none %}
                        {{ entry.best_metrics_oos.trades }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.overfit_gap is not none %}
                        <span class="overfit-gap {% if entry.overfit_gap > 0.3 %}overfit-warning{% elif entry.overfit_gap > 0.5 %}overfit-danger{% endif %}"
                              title="IS - OOS score difference">
                            {{ "%.3f"|format(entry.overfit_gap) }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.objective_type and entry.objective_type != 'sharpe' %}
                    <span class="objective-badge" title="{{ entry.objective_type }}">{{ entry.objective_type }}</span>
                    {% else %}
                    <span class="text-muted">sharpe</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.oos_ratio %}
                    <span class="oos-badge">{{ "%.0f"|format(entry.oos_ratio * 100) }}%</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <span class="relative-time" data-timestamp="{{ entry.created_at.isoformat() }}" title="{{ entry.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}">
                        {{ entry.created_at.strftime('%Y-%m-%d') }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination">
    <div class="pagination-info">
        Showing {{ offset + 1 }} - {{ [offset + limit, total]|min }} of {{ total }}
    </div>
    <div class="pagination-buttons">
        {% if has_prev %}
        <a href="/admin/backtests/leaderboard?workspace_id={{ workspace_id }}&valid_only={{ 'true' if valid_only else '' }}&include_canceled={{ 'true' if include_canceled else '' }}&objective_type={{ objective_type_filter or '' }}&oos_enabled={{ oos_enabled_filter or '' }}&limit={{ limit }}&offset={{ prev_offset }}"
           hx-get="/admin/backtests/leaderboard?workspace_id={{ workspace_id }}&valid_only={{ 'true' if valid_only else '' }}&include_canceled={{ 'true' if include_canceled else '' }}&objective_type={{ objective_type_filter or '' }}&oos_enabled={{ oos_enabled_filter or '' }}&limit={{ limit }}&offset={{ prev_offset }}"
           hx-target="#leaderboard-content"
           hx-push-url="true"
           class="btn btn-secondary">Previous</a>
        {% endif %}
        {% if has_next %}
        <a href="/admin/backtests/leaderboard?workspace_id={{ workspace_id }}&valid_only={{ 'true' if valid_only else '' }}&include_canceled={{ 'true' if include_canceled else '' }}&objective_type={{ objective_type_filter or '' }}&oos_enabled={{ oos_enabled_filter or '' }}&limit={{ limit }}&offset={{ next_offset }}"
           hx-get="/admin/backtests/leaderboard?workspace_id={{ workspace_id }}&valid_only={{ 'true' if valid_only else '' }}&include_canceled={{ 'true' if include_canceled else '' }}&objective_type={{ objective_type_filter or '' }}&oos_enabled={{ oos_enabled_filter or '' }}&limit={{ limit }}&offset={{ next_offset }}"
           hx-target="#leaderboard-content"
           hx-push-url="true"
           class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
</div>
{% else %}
<div class="empty-state">
    <h3>No entries on leaderboard</h3>
    <p>{% if valid_only %}No tunes with valid results match the current filters. Try unchecking "Valid only" or changing filters.{% else %}Complete some tuning sessions to see results here.{% endif %}</p>
</div>
{% endif %}
