{% extends "layout.html" %}

{% block title %}Event {{ event.id[:8] }}... - Admin{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="/admin/trade/events">Trade Events</a> /
    <span>{{ event.id[:8] }}...</span>
</div>

<!-- Header -->
<div class="detail-header">
    <h1>
        <span class="badge badge-{{ event.event_type.split('_')[0] }}">{{ event.event_type }}</span>
        Trade Event
    </h1>
    <div class="detail-meta">
        <span title="{{ event.id }}">
            ID: {{ event.id[:12] }}...
            <button onclick="copyToClipboard('{{ event.id }}')" class="copy-btn" title="Copy event ID">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
        </span>
        <span>{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
        {% if event.symbol %}
        <span>{{ event.symbol }}</span>
        {% endif %}
        {% if event.timeframe %}
        <span>{{ event.timeframe }}</span>
        {% endif %}
    </div>
</div>

<!-- Related Events Timeline -->
{% if related_events|length > 1 %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Correlation Timeline</h3>
        <span class="pagination-info">{{ related_events|length }} linked events</span>
    </div>
    <div class="timeline">
        {% for rel in related_events %}
        <div class="timeline-item {% if rel.is_current %}timeline-current{% endif %}">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
                <span class="badge badge-{{ rel.event_type.split('_')[0] }}" style="font-size: 11px;">{{ rel.event_type }}</span>
                <span class="timeline-time">{{ rel.created_at.strftime('%H:%M:%S.%f')[:12] }}</span>
                {% if not rel.is_current %}
                <a href="/admin/trade/events/{{ rel.id }}" class="timeline-link">View</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Key Info -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Event Details</h3>
    </div>
    <table>
        <tr>
            <th style="width: 150px;">Correlation ID</th>
            <td>
                <code style="font-size: 12px;">{{ event.correlation_id }}</code>
                <button onclick="copyToClipboard('{{ event.correlation_id }}')" class="copy-btn" title="Copy">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                </button>
            </td>
        </tr>
        <tr>
            <th>Workspace</th>
            <td><code style="font-size: 12px;">{{ event.workspace_id }}</code></td>
        </tr>
        {% if event.strategy_entity_id %}
        <tr>
            <th>Strategy</th>
            <td>
                <a href="/admin/kb/entities/{{ event.strategy_entity_id }}">{{ event.strategy_entity_id[:8] }}...</a>
            </td>
        </tr>
        {% endif %}
        {% if event.intent_id %}
        <tr>
            <th>Intent ID</th>
            <td><code style="font-size: 12px;">{{ event.intent_id }}</code></td>
        </tr>
        {% endif %}
        {% if event.order_id %}
        <tr>
            <th>Order ID</th>
            <td><code style="font-size: 12px;">{{ event.order_id }}</code></td>
        </tr>
        {% endif %}
        {% if event.position_id %}
        <tr>
            <th>Position ID</th>
            <td><code style="font-size: 12px;">{{ event.position_id }}</code></td>
        </tr>
        {% endif %}
    </table>
</div>

<!-- Payload -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Payload</h3>
        <button onclick="copyJson()" class="btn btn-secondary" style="font-size: 12px; padding: 4px 12px;">Copy JSON</button>
    </div>
    <div class="code-block" id="event-json">{{ event_json }}</div>
</div>

<style>
    .badge-intent { background: rgba(88, 166, 255, 0.2); color: var(--info); }
    .badge-policy { background: rgba(136, 87, 229, 0.2); color: #a371f7; }
    .badge-order { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .badge-position { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .badge-kill { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .badge-regime { background: rgba(255, 166, 87, 0.2); color: #f7a141; }

    .copy-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: var(--text-muted);
        border-radius: 4px;
        transition: background 0.15s;
        vertical-align: middle;
    }
    .copy-btn:hover { background: var(--bg); color: var(--text); }

    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 24px;
    }

    .timeline-item {
        position: relative;
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -18px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
    }

    .timeline-item:first-child::before { top: 50%; }
    .timeline-item:last-child::before { bottom: 50%; }

    .timeline-dot {
        position: absolute;
        left: -24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--border);
        border: 2px solid var(--bg-secondary);
    }

    .timeline-current .timeline-dot {
        background: var(--link);
    }

    .timeline-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .timeline-time {
        font-size: 12px;
        color: var(--text-muted);
        font-family: 'SF Mono', Consolas, monospace;
    }

    .timeline-link {
        font-size: 12px;
    }

    .timeline-current {
        background: rgba(56, 139, 253, 0.1);
        margin-left: -8px;
        padding-left: 8px;
        border-radius: 4px;
    }
</style>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
}

function copyJson() {
    const text = document.getElementById('event-json').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard');
    });
}
</script>
{% endblock %}
