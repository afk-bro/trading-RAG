{% extends "layout.html" %}

{% block title %}Strategy Backtest - KB Admin{% endblock %}

{% block content %}
<!-- Header -->
<div class="detail-header">
    <h1>Strategy Backtest</h1>
    <div class="detail-meta">
        <span>Run backtests on historical data with real-time results</span>
    </div>
</div>

<!-- Configuration Form -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Configuration</h3>
    </div>
    <form id="backtest-form" hx-post="/admin/backtests/strategy-test/run?token={{ request.query_params.get('token', '') }}" hx-target="#results-container" hx-indicator="#loading-indicator">
        <div class="form-grid">
            <div class="form-group">
                <label for="strategy">Strategy</label>
                <select id="strategy" name="strategy" required>
                    <option value="unicorn_model" selected>ICT Unicorn Model</option>
                </select>
            </div>

            <div class="form-group">
                <label for="symbol">Symbol</label>
                <select id="symbol" name="symbol" required>
                    <option value="NQ" selected>NQ (Nasdaq Futures)</option>
                    <option value="ES">ES (S&P Futures)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input type="date" id="start_date" name="start_date" value="2024-01-01" min="2021-01-28" max="2026-01-27" required>
            </div>

            <div class="form-group">
                <label for="end_date">End Date</label>
                <input type="date" id="end_date" name="end_date" value="2024-06-30" min="2021-01-28" max="2026-01-27" required>
            </div>

            <div class="form-group">
                <label for="direction">Direction Filter</label>
                <select id="direction" name="direction">
                    <option value="both">Both (Long & Short)</option>
                    <option value="long_only" selected>Long Only (Recommended)</option>
                    <option value="short_only">Short Only</option>
                </select>
            </div>

            <div class="form-group">
                <label for="min_criteria">Min Criteria Score</label>
                <select id="min_criteria" name="min_criteria">
                    <option value="2">2 of 5</option>
                    <option value="3" selected>3 of 5 (Default)</option>
                    <option value="4">4 of 5</option>
                    <option value="5">5 of 5 (Strict)</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <h4>Friction Settings</h4>
            <div class="form-grid form-grid-4">
                <div class="form-group">
                    <label for="platform">Trading Platform</label>
                    <select id="platform" name="platform">
                        <option value="apex_rithmic" selected>Apex (Rithmic) - $3.98</option>
                        <option value="apex_tradovate">Apex (Tradovate) - $3.10</option>
                        <option value="topstep">Topstep - $2.80</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="slippage">Slippage (ticks)</label>
                    <input type="number" id="slippage" name="slippage" value="2" min="0" max="10" step="0.5">
                </div>
                <div class="form-group">
                    <label for="commission">Commission ($/RT)</label>
                    <input type="number" id="commission" name="commission" value="3.98" min="0" max="20" step="0.01">
                </div>
                <div class="form-group">
                    <label for="intrabar_policy">Intrabar Policy</label>
                    <select id="intrabar_policy" name="intrabar_policy">
                        <option value="worst" selected>Worst (Conservative)</option>
                        <option value="best">Best (Optimistic)</option>
                        <option value="random">Random (50/50)</option>
                    </select>
                </div>
            </div>
            <p class="form-hint">Commission is round-turn (entry + exit). Apex Rithmic: $1.99/side, Tradovate: $1.55/side, Topstep: ~$1.40/side.</p>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="run-btn">
                <span class="btn-text">Run Backtest</span>
                <span class="btn-loading" style="display: none;">Running...</span>
            </button>
            <span id="loading-indicator" class="htmx-indicator">
                <span class="spinner"></span> Processing...
            </span>
        </div>
    </form>
</div>

<!-- Results Container -->
<div id="results-container">
    <!-- Results will be loaded here via HTMX -->
    <div class="card results-placeholder">
        <div class="placeholder-content">
            <p>Configure your backtest above and click "Run Backtest" to see results</p>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="chart-animation">
            <div class="bar bar-1"></div>
            <div class="bar bar-2"></div>
            <div class="bar bar-3"></div>
            <div class="bar bar-4"></div>
            <div class="bar bar-5"></div>
        </div>
        <div class="loading-text">Running Backtest</div>
        <div class="loading-subtext">Analyzing historical data...</div>
        <div class="progress-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    </div>
</div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('backtest-form');
    const runBtn = document.getElementById('run-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingSubtext = loadingOverlay.querySelector('.loading-subtext');

    const loadingMessages = [
        'Analyzing historical data...',
        'Identifying trade setups...',
        'Calculating entry signals...',
        'Processing exit conditions...',
        'Computing profit/loss...',
        'Generating analytics...'
    ];
    let messageIndex = 0;
    let messageInterval;

    // Show loading state on submit
    form.addEventListener('htmx:beforeRequest', function() {
        runBtn.querySelector('.btn-text').style.display = 'none';
        runBtn.querySelector('.btn-loading').style.display = 'inline';
        runBtn.disabled = true;
        loadingOverlay.classList.add('active');

        // Cycle through loading messages
        messageIndex = 0;
        loadingSubtext.textContent = loadingMessages[0];
        messageInterval = setInterval(function() {
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            loadingSubtext.style.opacity = 0;
            setTimeout(function() {
                loadingSubtext.textContent = loadingMessages[messageIndex];
                loadingSubtext.style.opacity = 1;
            }, 200);
        }, 2000);
    });

    // Reset button state after response
    form.addEventListener('htmx:afterRequest', function() {
        runBtn.querySelector('.btn-text').style.display = 'inline';
        runBtn.querySelector('.btn-loading').style.display = 'none';
        runBtn.disabled = false;
        loadingOverlay.classList.remove('active');
        clearInterval(messageInterval);
    });

    // Date validation
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');

    startDate.addEventListener('change', function() {
        endDate.min = this.value;
        if (endDate.value < this.value) {
            endDate.value = this.value;
        }
    });

    endDate.addEventListener('change', function() {
        startDate.max = this.value;
    });

    // Platform commission auto-fill
    const platform = document.getElementById('platform');
    const commission = document.getElementById('commission');
    const commissionRates = {
        'apex_rithmic': 3.98,
        'apex_tradovate': 3.10,
        'topstep': 2.80,
        'custom': null
    };

    platform.addEventListener('change', function() {
        const rate = commissionRates[this.value];
        if (rate !== null) {
            commission.value = rate.toFixed(2);
            commission.readOnly = true;
        } else {
            commission.readOnly = false;
        }
    });

    // Set initial state
    commission.readOnly = true;
});

// Called after HTMX loads results - renders charts
function renderResultCharts(data) {
    if (!data) return;

    // Render criteria bottleneck chart
    if (data.criteria_bottlenecks && data.criteria_bottlenecks.length > 0) {
        renderBottleneckChart(data.criteria_bottlenecks);
    }

    // Render session breakdown chart
    if (data.session_stats) {
        renderSessionChart(data.session_stats);
    }

    // Render exit breakdown chart
    if (data.exit_breakdown) {
        renderExitChart(data.exit_breakdown);
    }
}

function renderBottleneckChart(bottlenecks) {
    const container = document.getElementById('bottleneck-chart');
    if (!container) return;

    const data = [{
        type: 'bar',
        orientation: 'h',
        y: bottlenecks.map(b => b.criterion),
        x: bottlenecks.map(b => b.fail_rate * 100),
        marker: {
            color: bottlenecks.map(b => b.fail_rate > 0.7 ? '#f85149' : b.fail_rate > 0.4 ? '#d29922' : '#3fb950')
        },
        text: bottlenecks.map(b => (b.fail_rate * 100).toFixed(1) + '%'),
        textposition: 'outside',
        hovertemplate: '%{y}: %{x:.1f}% fail rate<extra></extra>'
    }];

    const layout = {
        title: { text: 'Criteria Fail Rate', font: { size: 14, color: '#8b949e' } },
        xaxis: { title: 'Fail Rate (%)', range: [0, 100], gridcolor: '#30363d' },
        yaxis: { autorange: 'reversed', gridcolor: '#30363d' },
        margin: { l: 120, r: 60, t: 40, b: 40 },
        paper_bgcolor: '#161b22',
        plot_bgcolor: '#0d1117',
        font: { color: '#c9d1d9' },
        height: 300
    };

    Plotly.newPlot(container, data, layout, { responsive: true, displayModeBar: false });
}

function renderSessionChart(sessionStats) {
    const container = document.getElementById('session-chart');
    if (!container) return;

    const sessions = Object.keys(sessionStats).filter(s => sessionStats[s].trades > 0);
    if (sessions.length === 0) return;

    const data = [{
        type: 'bar',
        x: sessions.map(s => s.replace('_', ' ').toUpperCase()),
        y: sessions.map(s => sessionStats[s].pnl),
        marker: {
            color: sessions.map(s => sessionStats[s].pnl >= 0 ? '#3fb950' : '#f85149')
        },
        text: sessions.map(s => sessionStats[s].pnl.toFixed(1) + 'pt'),
        textposition: 'outside',
        hovertemplate: '%{x}<br>PnL: %{y:.1f} points<br>Trades: ' +
            sessions.map(s => sessionStats[s].trades).join(',') + '<extra></extra>'
    }];

    const layout = {
        title: { text: 'PnL by Session', font: { size: 14, color: '#8b949e' } },
        xaxis: { gridcolor: '#30363d' },
        yaxis: { title: 'PnL (points)', gridcolor: '#30363d' },
        margin: { l: 60, r: 40, t: 40, b: 60 },
        paper_bgcolor: '#161b22',
        plot_bgcolor: '#0d1117',
        font: { color: '#c9d1d9' },
        height: 250
    };

    Plotly.newPlot(container, data, layout, { responsive: true, displayModeBar: false });
}

function renderExitChart(exitBreakdown) {
    const container = document.getElementById('exit-chart');
    if (!container) return;

    const reasons = Object.keys(exitBreakdown);
    if (reasons.length === 0) return;

    const data = [{
        type: 'pie',
        labels: reasons.map(r => r.replace('_', ' ')),
        values: reasons.map(r => exitBreakdown[r].count),
        marker: {
            colors: reasons.map(r => {
                if (r === 'target') return '#3fb950';
                if (r === 'stop_loss') return '#f85149';
                if (r === 'time_stop') return '#d29922';
                return '#58a6ff';
            })
        },
        textinfo: 'label+percent',
        hovertemplate: '%{label}<br>Count: %{value}<br>PnL: ' +
            reasons.map(r => exitBreakdown[r].pnl.toFixed(1) + 'h').join(',') + '<extra></extra>'
    }];

    const layout = {
        title: { text: 'Exit Reasons', font: { size: 14, color: '#8b949e' } },
        margin: { l: 20, r: 20, t: 40, b: 20 },
        paper_bgcolor: '#161b22',
        font: { color: '#c9d1d9' },
        height: 250,
        showlegend: false
    };

    Plotly.newPlot(container, data, layout, { responsive: true, displayModeBar: false });
}
</script>

<style>
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .form-grid-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .form-grid-4 {
        grid-template-columns: repeat(4, 1fr);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .form-group label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        font-weight: var(--font-weight-medium);
    }

    .form-group input,
    .form-group select {
        padding: var(--space-2) var(--space-3);
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text);
        font-size: var(--font-size-base);
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--info);
    }

    .form-section {
        margin-top: var(--space-5);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border);
    }

    .form-section h4 {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        margin-bottom: var(--space-3);
        font-weight: var(--font-weight-medium);
    }

    .form-hint {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: var(--space-2);
        opacity: 0.8;
    }

    .form-group input[readonly] {
        background: var(--bg-secondary);
        cursor: not-allowed;
        opacity: 0.8;
    }

    .form-actions {
        margin-top: var(--space-5);
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }

    .btn {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        border: none;
        transition: all var(--transition-base);
    }

    .btn-primary {
        background: var(--info);
        color: #fff;
    }

    .btn-primary:hover {
        background: #4dabf7;
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .htmx-indicator {
        display: none;
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .htmx-request .htmx-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top-color: var(--info);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .results-placeholder {
        text-align: center;
        padding: var(--space-8);
    }

    .placeholder-content {
        color: var(--text-muted);
    }

    @media (max-width: 992px) {
        .form-grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .form-grid-3,
        .form-grid-4 {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(13, 17, 23, 0.92);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .loading-content {
        text-align: center;
    }

    /* Animated Chart Bars */
    .chart-animation {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 8px;
        height: 80px;
        margin-bottom: 24px;
    }

    .bar {
        width: 16px;
        background: linear-gradient(to top, #3fb950, #58a6ff);
        border-radius: 4px 4px 0 0;
        animation: barPulse 1.2s ease-in-out infinite;
    }

    .bar-1 { height: 30%; animation-delay: 0s; }
    .bar-2 { height: 60%; animation-delay: 0.1s; }
    .bar-3 { height: 45%; animation-delay: 0.2s; }
    .bar-4 { height: 80%; animation-delay: 0.3s; }
    .bar-5 { height: 55%; animation-delay: 0.4s; }

    @keyframes barPulse {
        0%, 100% {
            transform: scaleY(1);
            opacity: 0.7;
        }
        50% {
            transform: scaleY(1.3);
            opacity: 1;
        }
    }

    .loading-text {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-bright);
        margin-bottom: 8px;
    }

    .loading-subtext {
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-bottom: 20px;
        transition: opacity 0.2s ease;
        min-height: 1.5em;
    }

    /* Progress Dots */
    .progress-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .dot {
        width: 10px;
        height: 10px;
        background: var(--info);
        border-radius: 50%;
        animation: dotBounce 1.4s ease-in-out infinite;
    }

    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotBounce {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
{% endblock %}
