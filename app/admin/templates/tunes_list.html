{% extends "layout.html" %}

{% block title %}Tune Sessions - KB Admin{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Parameter Tuning Sessions</h2>
        <div class="header-right">
            <span id="refresh-indicator" class="refresh-indicator" style="display: none;">
                <span class="spinner"></span> Auto-refreshing
            </span>
            <span class="pagination-info">{{ total }} total</span>
        </div>
    </div>

    <!-- Filters (HTMX-powered) -->
    <form method="get" class="filters"
          hx-get="/admin/backtests/tunes"
          hx-target="#tunes-content"
          hx-push-url="true"
          hx-trigger="change from:input, change from:select"
          hx-indicator="#loading-indicator">
        <input type="hidden" name="workspace_id" value="{{ workspace_id }}">
        <select name="status">
            <option value="">All Statuses</option>
            <option value="queued" {% if status_filter == 'queued' %}selected{% endif %}>Queued</option>
            <option value="running" {% if status_filter == 'running' %}selected{% endif %}>Running</option>
            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
            <option value="canceled" {% if status_filter == 'canceled' %}selected{% endif %}>Canceled</option>
            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
        </select>
        <label class="filter-checkbox" title="Only show tunes with valid results">
            <input type="checkbox" name="valid_only" value="true" {% if valid_only %}checked{% endif %}>
            Valid only
        </label>
        <select name="objective_type">
            <option value="">All Objectives</option>
            <option value="sharpe" {% if objective_type_filter == 'sharpe' %}selected{% endif %}>sharpe</option>
            <option value="sharpe_dd_penalty" {% if objective_type_filter == 'sharpe_dd_penalty' %}selected{% endif %}>sharpe_dd_penalty</option>
            <option value="return" {% if objective_type_filter == 'return' %}selected{% endif %}>return</option>
            <option value="return_dd_penalty" {% if objective_type_filter == 'return_dd_penalty' %}selected{% endif %}>return_dd_penalty</option>
            <option value="calmar" {% if objective_type_filter == 'calmar' %}selected{% endif %}>calmar</option>
        </select>
        <select name="oos_enabled">
            <option value="">All OOS</option>
            <option value="true" {% if oos_enabled_filter == 'true' %}selected{% endif %}>With OOS</option>
            <option value="false" {% if oos_enabled_filter == 'false' %}selected{% endif %}>IS only</option>
        </select>
        <select name="limit" class="page-size-select" title="Items per page">
            <option value="20" {% if limit == 20 %}selected{% endif %}>20 / page</option>
            <option value="50" {% if limit == 50 %}selected{% endif %}>50 / page</option>
            <option value="100" {% if limit == 100 %}selected{% endif %}>100 / page</option>
        </select>
        <span id="loading-indicator" class="htmx-indicator">Loading...</span>
    </form>

    <!-- HTMX target for table content -->
    <div id="tunes-content">
        {% include "tunes_list_partial.html" %}
    </div>
</div>

<style>
    .header-right { display: flex; align-items: center; gap: 16px; }
    .refresh-indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--info); }
    .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--info); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .filters { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-checkbox { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; }
    .filter-checkbox input { cursor: pointer; }
    .page-size-select { min-width: 90px; }

    /* Pagination styles */
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .pagination-info { color: var(--text-muted); font-size: 13px; }
    .pagination-controls { display: flex; align-items: center; gap: 8px; }
    .page-numbers { display: flex; gap: 4px; }
    .page-num { min-width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 13px; text-decoration: none; color: var(--text); background: var(--bg); border: 1px solid var(--border); cursor: pointer; }
    .page-num:hover { background: var(--bg-secondary); text-decoration: none; }
    .page-num.active { background: var(--link); color: white; border-color: var(--link); }
    .page-num.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .page-ellipsis { color: var(--text-muted); padding: 0 4px; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    thead th { border-bottom: 2px solid var(--border); white-space: nowrap; }

    .clickable-row { cursor: pointer; transition: background 0.15s; }
    .clickable-row:hover { background: rgba(56, 139, 253, 0.15); }

    .badge-queued { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }
    .badge-running { background: rgba(88, 166, 255, 0.2); color: var(--info); }
    .badge-completed { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .badge-failed { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .badge-skipped { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .badge-canceled { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .text-muted { color: var(--text-muted); }

    .validity-badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .validity-valid { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .validity-invalid { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .validity-canceled { background: rgba(248, 81, 73, 0.2); color: var(--danger); }

    .objective-badge { background: rgba(255, 166, 87, 0.2); color: #f7a141; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .oos-badge { background: rgba(136, 87, 229, 0.2); color: #a371f7; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .gates-compact { font-size: 11px; font-family: 'SF Mono', Consolas, monospace; color: var(--text-muted); }

    .trials-breakdown { display: flex; gap: 4px; align-items: center; }
    .trial-stat { padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .trial-stat.valid { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .trial-stat.skipped { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .trial-stat.failed { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .trial-stat.running { background: rgba(88, 166, 255, 0.2); color: var(--info); }
    .trial-stat.queued { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }
    .trial-total { color: var(--text-muted); font-size: 12px; margin-left: 2px; }

    .row-actions { display: flex; gap: 8px; align-items: center; justify-content: flex-end; }
    .copy-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-muted); border-radius: 4px; opacity: 0; transition: opacity 0.15s, background 0.15s; }
    .clickable-row:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { background: var(--bg); color: var(--text); }

    .empty-hint { margin-top: 16px; text-align: left; display: inline-block; }
    .empty-hint code { background: var(--bg); padding: 4px 8px; border-radius: 4px; font-size: 13px; }
    .empty-hint pre { background: var(--bg); padding: 12px; border-radius: 6px; font-size: 12px; margin-top: 8px; text-align: left; overflow-x: auto; }

    /* HTMX loading states */
    .htmx-indicator { display: none; color: var(--text-muted); font-size: 12px; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-request #tunes-content { opacity: 0.5; pointer-events: none; transition: opacity 0.15s; }
</style>

<script>
// Clickable rows with Ctrl/Cmd+click for new tab
function initClickableRows() {
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.removeEventListener('click', handleRowClick);
        row.addEventListener('click', handleRowClick);
    });
}

function handleRowClick(e) {
    if (e.target.closest('a, button')) return;
    const href = this.dataset.href;
    if (e.ctrlKey || e.metaKey) {
        window.open(href, '_blank');
    } else {
        window.location.href = href;
    }
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
}

// Relative time formatting
function formatRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (seconds < 60) return 'just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

function updateRelativeTimes() {
    document.querySelectorAll('.relative-time').forEach(el => {
        const timestamp = el.dataset.timestamp;
        if (timestamp) {
            const date = new Date(timestamp);
            el.textContent = formatRelativeTime(date);
        }
    });
}

// Initialize everything
function initTunesList() {
    initClickableRows();
    updateRelativeTimes();
    checkAutoRefresh();
}

// Auto-refresh using HTMX while any tune is running/queued
let autoRefreshInterval = null;

function checkAutoRefresh() {
    const hasRunning = document.querySelector('.badge-running, .badge-queued') !== null;
    const indicator = document.getElementById('refresh-indicator');

    if (hasRunning && !autoRefreshInterval) {
        indicator.style.display = 'flex';
        autoRefreshInterval = setInterval(() => {
            htmx.trigger('#tunes-content', 'htmx:trigger');
            // Trigger a GET request to refresh content
            const form = document.querySelector('form.filters');
            if (form) htmx.trigger(form, 'change');
        }, 3000);
    } else if (!hasRunning && autoRefreshInterval) {
        indicator.style.display = 'none';
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Stop refresh on visibility change (tab hidden)
document.addEventListener('visibilitychange', () => {
    if (document.hidden && autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    } else if (!document.hidden) {
        checkAutoRefresh();
    }
});

// Initial setup
document.addEventListener('DOMContentLoaded', initTunesList);

// Re-initialize after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'tunes-content') {
        initTunesList();
    }
});

// Update relative times periodically
setInterval(updateRelativeTimes, 60000);
</script>
{% endblock %}
