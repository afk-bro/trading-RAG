<!-- Backtest Results Partial (loaded via HTMX) -->

{% if error %}
<div class="card card-error">
    <div class="error-content">
        <h3>Backtest Failed</h3>
        <p>{{ error }}</p>
    </div>
</div>
{% else %}

<!-- R-Metrics (Primary) -->
<div class="card card-highlight">
    <div class="card-header">
        <h3 class="card-title">R-Metrics</h3>
        <div class="result-badges">
            <span class="badge badge-{{ 'success' if result.avg_r_multiple >= 0 else 'danger' }}">
                {{ '%+.2f' | format(result.avg_r_multiple) }}R Avg
            </span>
            <span class="badge badge-type">{{ result.symbol }}</span>
            <span class="badge badge-type">{{ result.direction_filter or 'Both' }}</span>
        </div>
    </div>
    <div class="stats stats-primary">
        <div class="stat stat-large">
            <div class="stat-value{% if result.avg_r_multiple >= 0 %} text-success{% else %} text-danger{% endif %}">
                {{ '%+.2f' | format(result.avg_r_multiple) }}R
            </div>
            <div class="stat-label">Avg R per Trade</div>
        </div>
        <div class="stat stat-large">
            <div class="stat-value{% if result.total_r >= 0 %} text-success{% else %} text-danger{% endif %}">
                {{ '%+.1f' | format(result.total_r) }}R
            </div>
            <div class="stat-label">Total R</div>
        </div>
        <div class="stat stat-large">
            <div class="stat-value text-success">{{ '%+.2f' | format(result.best_r) }}R</div>
            <div class="stat-label">Max Win</div>
        </div>
        <div class="stat stat-large">
            <div class="stat-value text-danger">{{ '%.2f' | format(result.worst_r) }}R</div>
            <div class="stat-label">Max Loss</div>
        </div>
    </div>
</div>

<!-- Expectancy Analysis -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Expectancy Analysis</h3>
        <span class="badge badge-type">E = (Win% × Avg Win R) − (Loss% × |Avg Loss R|)</span>
    </div>
    <div class="expectancy-grid">
        <div class="expectancy-formula">
            <div class="formula-part">
                <span class="formula-value text-success">{{ '%.1f' | format(result.win_rate * 100) }}%</span>
                <span class="formula-label">Win Rate</span>
            </div>
            <span class="formula-op">×</span>
            <div class="formula-part">
                <span class="formula-value text-success">{{ '%+.2f' | format(result.avg_win_r) }}R</span>
                <span class="formula-label">Avg Win</span>
            </div>
            <span class="formula-op">−</span>
            <div class="formula-part">
                <span class="formula-value text-danger">{{ '%.1f' | format((1 - result.win_rate) * 100) }}%</span>
                <span class="formula-label">Loss Rate</span>
            </div>
            <span class="formula-op">×</span>
            <div class="formula-part">
                <span class="formula-value text-danger">{{ '%.2f' | format(result.avg_loss_r|abs) }}R</span>
                <span class="formula-label">Avg Loss</span>
            </div>
            <span class="formula-op">=</span>
            <div class="formula-part formula-result">
                <span class="formula-value{% if result.expectancy_r >= 0 %} text-success{% else %} text-danger{% endif %}">
                    {{ '%+.3f' | format(result.expectancy_r) }}R
                </span>
                <span class="formula-label">Expectancy</span>
            </div>
        </div>
    </div>
</div>

<!-- R Distribution -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">R Distribution</h3>
        <span class="badge badge-type">{{ result.trades_taken }} trades</span>
    </div>
    <div class="r-distribution">
        {% for bucket in result.r_distribution %}
        <div class="r-bucket">
            <div class="r-bucket-label">{{ bucket.label }}</div>
            <div class="r-bucket-bar-container">
                <div class="r-bucket-bar {% if '< -1' in bucket.label or '-1.0 to 0' in bucket.label %}bar-loss{% elif '0 to +1' in bucket.label %}bar-neutral{% else %}bar-win{% endif %}"
                     style="width: {{ bucket.pct }}%;">
                </div>
            </div>
            <div class="r-bucket-count">{{ bucket.count }} ({{ '%.0f' | format(bucket.pct) }}%)</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Trade Stats -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Trade Statistics</h3>
        <div class="result-badges">
            <span class="badge badge-{{ 'success' if result.profit_factor >= 1.0 else 'danger' }}">
                PF {{ '%.2f' | format(result.profit_factor) }}
            </span>
        </div>
    </div>
    <div class="stats">
        <div class="stat">
            <div class="stat-value">{{ result.trades_taken }}</div>
            <div class="stat-label">Trades</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ result.wins }}/{{ result.losses }}</div>
            <div class="stat-label">Wins/Losses</div>
        </div>
        <div class="stat">
            <div class="stat-value{% if result.win_rate >= 0.4 %} text-success{% else %} text-danger{% endif %}">
                {{ '%.1f' | format(result.win_rate * 100) }}%
            </div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat">
            <div class="stat-value{% if result.profit_factor >= 1.0 %} text-success{% else %} text-danger{% endif %}">
                {{ '%.2f' | format(result.profit_factor) }}
            </div>
            <div class="stat-label">Profit Factor</div>
        </div>
        <div class="stat">
            <div class="stat-value{% if result.total_pnl_handles >= 0 %} text-success{% else %} text-danger{% endif %}">
                {{ '%+.1f' | format(result.total_pnl_handles) }}h
            </div>
            <div class="stat-label">Total PnL</div>
        </div>
        <div class="stat">
            <div class="stat-value{% if result.total_pnl_dollars >= 0 %} text-success{% else %} text-danger{% endif %}">
                ${{ '{:+,.0f}'.format(result.total_pnl_dollars) }}
            </div>
            <div class="stat-label">PnL ($)</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-grid">
    <!-- Session Breakdown -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Session Breakdown</h3>
        </div>
        <div id="session-chart"></div>
        <table class="mini-table">
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Trades</th>
                    <th>Win Rate</th>
                    <th>PnL</th>
                </tr>
            </thead>
            <tbody>
                {% for session, stats in result.session_stats.items() %}
                {% if stats.trades > 0 %}
                <tr>
                    <td>{{ session.replace('_', ' ').upper() }}</td>
                    <td>{{ stats.trades }}</td>
                    <td>{{ '%.1f' | format(stats.win_rate * 100) }}%</td>
                    <td class="{% if stats.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ '%+.1f' | format(stats.pnl) }}h
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Exit Breakdown -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Exit Reasons</h3>
        </div>
        <div id="exit-chart"></div>
        <table class="mini-table">
            <thead>
                <tr>
                    <th>Reason</th>
                    <th>Count</th>
                    <th>Win Rate</th>
                    <th>PnL</th>
                </tr>
            </thead>
            <tbody>
                {% for reason, data in result.exit_breakdown.items() %}
                <tr>
                    <td>{{ reason.replace('_', ' ').title() }}</td>
                    <td>{{ data.count }}</td>
                    <td>{{ '%.1f' | format(data.win_rate * 100) }}%</td>
                    <td class="{% if data.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ '%+.1f' | format(data.pnl) }}h
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Criteria Bottleneck -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Criteria Bottleneck Analysis</h3>
        <span class="badge badge-type">Why setups fail</span>
    </div>
    <div id="bottleneck-chart"></div>
</div>

<!-- MFE/MAE Analysis -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">MFE / MAE Analysis</h3>
    </div>
    <div class="stats stats-small">
        <div class="stat">
            <div class="stat-value">{{ '%.1f' | format(result.avg_mfe) }}h</div>
            <div class="stat-label">Avg MFE</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ '%.1f' | format(result.avg_mae) }}h</div>
            <div class="stat-label">Avg MAE</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ '%.1f' | format(result.mfe_capture_rate * 100) }}%</div>
            <div class="stat-label">MFE Capture</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ '%+.1f' | format(result.largest_win) }}h</div>
            <div class="stat-label">Largest Win</div>
        </div>
        <div class="stat">
            <div class="stat-value text-danger">{{ '%.1f' | format(result.largest_loss) }}h</div>
            <div class="stat-label">Largest Loss</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ '%+.2f' | format(result.best_r) }}R</div>
            <div class="stat-label">Best R</div>
        </div>
        <div class="stat">
            <div class="stat-value text-danger">{{ '%.2f' | format(result.worst_r) }}R</div>
            <div class="stat-label">Worst R</div>
        </div>
    </div>
</div>

<!-- Confidence Buckets -->
{% if result.confidence_buckets %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Confidence vs Win Rate</h3>
        <span class="badge badge-type">Correlation: {{ '%+.3f' | format(result.confidence_correlation) }}</span>
    </div>
    <table>
        <thead>
            <tr>
                <th>Confidence Range</th>
                <th>Trades</th>
                <th>Win Rate</th>
                <th>Avg R</th>
                <th>Total PnL</th>
            </tr>
        </thead>
        <tbody>
            {% for bucket in result.confidence_buckets %}
            <tr>
                <td>{{ '%.1f' | format(bucket.min_conf) }} - {{ '%.1f' | format(bucket.max_conf) }}</td>
                <td>{{ bucket.trades }}</td>
                <td>{{ '%.1f' | format(bucket.win_rate * 100) }}%</td>
                <td>{{ '%+.2f' | format(bucket.avg_r) }}R</td>
                <td class="{% if bucket.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ '%+.1f' | format(bucket.pnl) }}h
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Configuration Used -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Configuration</h3>
        <button onclick="toggleConfig()" class="btn btn-secondary btn-sm">Toggle</button>
    </div>
    <div id="config-details" style="display: none;">
        <div class="config-grid">
            <div class="config-item">
                <span class="config-label">Period:</span>
                <span>{{ result.start_date }} to {{ result.end_date }}</span>
            </div>
            <div class="config-item">
                <span class="config-label">Symbol:</span>
                <span>{{ result.symbol }}</span>
            </div>
            <div class="config-item">
                <span class="config-label">Direction:</span>
                <span>{{ result.direction_filter or 'Both' }}</span>
            </div>
            <div class="config-item">
                <span class="config-label">Min Criteria:</span>
                <span>{{ result.min_criteria }}/5 scored</span>
            </div>
            <div class="config-item">
                <span class="config-label">Slippage:</span>
                <span>{{ result.slippage }} ticks</span>
            </div>
            <div class="config-item">
                <span class="config-label">Commission:</span>
                <span>${{ '%.2f' | format(result.commission) }}/contract</span>
            </div>
            <div class="config-item">
                <span class="config-label">Intrabar Policy:</span>
                <span>{{ result.intrabar_policy }}</span>
            </div>
            <div class="config-item">
                <span class="config-label">HTF Bars:</span>
                <span>{{ result.htf_bars }}</span>
            </div>
            <div class="config-item">
                <span class="config-label">LTF Bars:</span>
                <span>{{ result.ltf_bars }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Initialize Charts -->
<script>
(function() {
    const chartData = {{ chart_data | tojson }};
    renderResultCharts(chartData);
})();

function toggleConfig() {
    const el = document.getElementById('config-details');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
</script>

<style>
    .card-error {
        background: rgba(248, 81, 73, 0.1);
        border-color: var(--danger);
    }

    .error-content {
        text-align: center;
        padding: var(--space-4);
    }

    .error-content h3 {
        color: var(--danger);
        margin-bottom: var(--space-2);
    }

    .result-badges {
        display: flex;
        gap: var(--space-2);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .mini-table {
        width: 100%;
        font-size: var(--font-size-sm);
        margin-top: var(--space-3);
    }

    .mini-table th {
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        text-align: left;
        padding: var(--space-2);
        border-bottom: 1px solid var(--border);
    }

    .mini-table td {
        padding: var(--space-2);
        border-bottom: 1px solid var(--border);
    }

    .stats-small .stat {
        padding: var(--space-3);
    }

    .stats-small .stat-value {
        font-size: var(--font-size-lg);
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-3);
        padding: var(--space-3);
    }

    .config-item {
        display: flex;
        gap: var(--space-2);
    }

    .config-label {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .btn-sm {
        padding: var(--space-1) var(--space-2);
        font-size: var(--font-size-sm);
    }

    .btn-secondary {
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text);
    }

    .btn-secondary:hover {
        background: var(--bg-secondary);
    }

    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }

    /* R-Metrics Card Highlight */
    .card-highlight {
        border-color: var(--info);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(88, 166, 255, 0.05) 100%);
    }

    .stats-primary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
    }

    .stat-large .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
    }

    /* Expectancy Formula */
    .expectancy-grid {
        padding: var(--space-4);
    }

    .expectancy-formula {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        flex-wrap: wrap;
    }

    .formula-part {
        text-align: center;
        padding: var(--space-2) var(--space-3);
        background: var(--bg);
        border-radius: var(--radius-md);
    }

    .formula-result {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
    }

    .formula-value {
        font-size: 1.25rem;
        font-weight: 600;
        display: block;
    }

    .formula-label {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .formula-op {
        font-size: 1.25rem;
        color: var(--text-muted);
        font-weight: 300;
    }

    /* R Distribution */
    .r-distribution {
        padding: var(--space-3);
    }

    .r-bucket {
        display: grid;
        grid-template-columns: 100px 1fr 80px;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
    }

    .r-bucket-label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        text-align: right;
    }

    .r-bucket-bar-container {
        height: 20px;
        background: var(--bg);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }

    .r-bucket-bar {
        height: 100%;
        min-width: 2px;
        border-radius: var(--radius-sm);
        transition: width 0.3s ease;
    }

    .bar-loss { background: var(--danger); }
    .bar-neutral { background: var(--warning); }
    .bar-win { background: var(--success); }

    .r-bucket-count {
        font-size: var(--font-size-sm);
        color: var(--text);
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .stats-primary {
            grid-template-columns: repeat(2, 1fr);
        }

        .expectancy-formula {
            flex-direction: column;
            gap: var(--space-2);
        }

        .formula-op {
            display: none;
        }
    }
</style>

{% endif %}
